(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.tus=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.encode=encode;var _window=window,btoa=_window.btoa;function encode(data){return btoa(unescape(encodeURIComponent(data)))}var isSupported=exports.isSupported="btoa"in window},{}],2:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var DetailedError=function(_Error){_inherits(DetailedError,_Error);function DetailedError(error){var causingErr=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var xhr=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;_classCallCheck(this,DetailedError);var _this=_possibleConstructorReturn(this,(DetailedError.__proto__||Object.getPrototypeOf(DetailedError)).call(this,error.message));_this.originalRequest=xhr;_this.causingError=causingErr;var message=error.message;if(causingErr!=null){message+=", caused by "+causingErr.toString()}if(xhr!=null){message+=", originated from request (response code: "+xhr.status+", response text: "+xhr.responseText+")"}_this.message=message;return _this}return DetailedError}(Error);exports.default=DetailedError},{}],3:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=fingerprint;function fingerprint(file){return["tus",file.name,file.type,file.size,file.lastModified].join("-")}},{}],4:[function(_dereq_,module,exports){"use strict";var _upload=_dereq_("./upload");var _upload2=_interopRequireDefault(_upload);var _storage=_dereq_("./storage");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var defaultOptions=_upload2.default.defaultOptions;if(typeof window!=="undefined"){var _window=window,XMLHttpRequest=_window.XMLHttpRequest,Blob=_window.Blob;var isSupported=XMLHttpRequest&&Blob&&typeof Blob.prototype.slice==="function"}else{var isSupported=true}module.exports={Upload:_upload2.default,isSupported:isSupported,canStoreURLs:_storage.canStoreURLs,defaultOptions:defaultOptions}},{"./storage":6,"./upload":7}],5:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();exports.getSource=getSource;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var FileSource=function(){function FileSource(file){_classCallCheck(this,FileSource);this._file=file;this.size=file.size}_createClass(FileSource,[{key:"slice",value:function slice(start,end){return this._file.slice(start,end)}},{key:"close",value:function close(){}}]);return FileSource}();function getSource(input){if(typeof input.slice==="function"&&typeof input.size!=="undefined"){return new FileSource(input)}throw new Error("source object may only be an instance of File or Blob in this environment")}},{}],6:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.setItem=setItem;exports.getItem=getItem;exports.removeItem=removeItem;var hasStorage=false;try{hasStorage="localStorage"in window;var key="tusSupport";localStorage.setItem(key,localStorage.getItem(key))}catch(e){if(e.code===e.SECURITY_ERR||e.code===e.QUOTA_EXCEEDED_ERR){hasStorage=false}else{throw e}}var canStoreURLs=exports.canStoreURLs=hasStorage;function setItem(key,value){if(!hasStorage)return;return localStorage.setItem(key,value)}function getItem(key){if(!hasStorage)return;return localStorage.getItem(key)}function removeItem(key){if(!hasStorage)return;return localStorage.removeItem(key)}},{}],7:[function(_dereq_,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _fingerprint=_dereq_("./fingerprint");var _fingerprint2=_interopRequireDefault(_fingerprint);var _error=_dereq_("./error");var _error2=_interopRequireDefault(_error);var _extend=_dereq_("extend");var _extend2=_interopRequireDefault(_extend);var _source=_dereq_("./source");var _base=_dereq_("./base64");var Base64=_interopRequireWildcard(_base);var _storage=_dereq_("./storage");var Storage=_interopRequireWildcard(_storage);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var defaultOptions={wsendpoint:"",fingerprint:_fingerprint2.default,resume:true,onProgress:null,onChunkComplete:null,onSuccess:null,onError:null,headers:{},chunkSize:Infinity,withCredentials:false,uploadUrl:null,uploadSize:null};var Upload=function(){function Upload(file,options){_classCallCheck(this,Upload);this.options=(0,_extend2.default)(true,{},defaultOptions,options);this.file=file;this._ws=null;this._source=null;this._size=null;this._aborted=false;this.url=null;this._fingerprint=null;this._offset=null}_createClass(Upload,[{key:"startWSTest",value:function startWSTest(){this._createUpload()}},{key:"start",value:function start(){if(!window.WebSocket){this._emitError(new Error("tus: your browser doesn't supports WebSocket"));return}if(!this.options.wsendpoint){this._emitError(new Error("tus: no wsendpoint provided"));return}var file=this.file;if(!file){this._emitError(new Error("tus: no file or stream to upload provided"));return}var source=this._source=(0,_source.getSource)(file,this.options.chunkSize);if(this.options.uploadSize!=null){var size=+this.options.uploadSize;if(isNaN(size)){throw new Error("tus: cannot convert `uploadSize` option into a number")}this._size=size}else{var _size=source.size;if(_size==null){throw new Error("tus: cannot automatically derive upload's size from input and must be specified manually using the `uploadSize` option")}this._size=_size}this._aborted=false;if(this.url!=null){this._resumeUpload();return}if(this.options.uploadUrl!=null){this.url=this.options.uploadUrl;this._resumeUpload();return}if(this.options.resume){this._fingerprint=this.options.fingerprint(file);var resumedUrl=Storage.getItem(this._fingerprint);if(resumedUrl!=null){this.url=resumedUrl;this._resumeUpload();return}}this._createUpload()}},{key:"_setRequestHeaders",value:function _setRequestHeaders(){var headers={"Tus-Resumable":"1.0.0"};var optionsHeaders=this.options.headers;for(var name in optionsHeaders){headers[name]=optionsHeaders[name]}return headers}},{key:"_createUpload",value:function _createUpload(){var _this=this;var ws=this._newWebSocket();ws.onopen=function(event){console.log("[Create] WS opened: ",event);var headers=_this._setRequestHeaders();headers["Upload-Length"]=_this._size;var metadata=encodeMetadata(_this.options.metadata);if(metadata!==""){headers["Upload-Metadata"]=metadata}ws.send(JSON.stringify({method:"POST",headers:headers,body:null}))};ws.onerror=function(event){console.log("[Create] WS error: ",event);throw new Error("tus: failed to create upload")};ws.onclose=function(event){console.log("[Create] WS closed: ",event);throw new Error("tus: failed to create upload")};ws.onmessage=function(message){var response=JSON.parse(message.data);console.log("[Create] WS message: ",message);console.log("[Create] WS data: ",response);if(!inStatusCategory(response.status,200)){_this._emitError(new Error("tus: unexpected response while creating upload"));return}_this.url=response.headers["Location"];if(_this.options.resume){Storage.setItem(_this._fingerprint,_this.url)}_this._offset=0;_this._startUpload()}}},{key:"_newWebSocket",value:function _newWebSocket(){return new WebSocket("ws://"+this.options.wsendpoint+"/ws")}},{key:"abort",value:function abort(){if(this._xhr!==null){this._xhr.abort();this._source.close();this._aborted=true}if(this._retryTimeout!=null){clearTimeout(this._retryTimeout);this._retryTimeout=null}}},{key:"_emitXhrError",value:function _emitXhrError(xhr,err,causingErr){this._emitError(new _error2.default(err,causingErr,xhr))}},{key:"_emitError",value:function _emitError(err){if(typeof this.options.onError==="function"){this.options.onError(err)}else{throw err}}},{key:"_emitSuccess",value:function _emitSuccess(){if(typeof this.options.onSuccess==="function"){this.options.onSuccess()}}},{key:"_emitProgress",value:function _emitProgress(bytesSent,bytesTotal){if(typeof this.options.onProgress==="function"){this.options.onProgress(bytesSent,bytesTotal)}}},{key:"_emitChunkComplete",value:function _emitChunkComplete(chunkSize,bytesAccepted,bytesTotal){if(typeof this.options.onChunkComplete==="function"){this.options.onChunkComplete(chunkSize,bytesAccepted,bytesTotal)}}},{key:"_resumeUpload",value:function _resumeUpload(){var _this2=this;var ws=this._newWebSocket();ws.onopen=function(event){console.log("[Resume] WS opened: ",event);ws.send({method:"HEAD",headers:_this2._setRequestHeaders(),body:null})};ws.onerror=function(event){console.log("[Resume] WS error: ",event);_this2._emitError(new Error("tus: failed to resume upload"))};ws.onclose=function(event){console.log("[Resume] WS closed: ",event);_this2._emitError(new Error("tus: failed to resume upload"))};ws.onmessage=function(message){var response=JSON.parse(message.data);var headers=response.headers;console.log("[Resume] WS message: ",message);console.log("[Resume] WS data: ",response);if(!inStatusCategory(response.status,200)){if(_this2.options.resume&&inStatusCategory(response.status,400)){Storage.removeItem(_this2._fingerprint)}if(response.status===423){_this2._emitError(new Error("tus: upload is currently locked; retry later"));return}_this2.url=null;_this2._createUpload();return}var offset=parseInt(headers["Upload-Offset"],10);if(isNaN(offset)){_this2._emitError(new Error("tus: invalid or missing offset value"));return}var length=parseInt(headers["Upload-Length"],10);if(isNaN(length)){_this2._emitError(new Error("tus: invalid or missing length value"));return}if(offset===length){_this2._emitProgress(length,length);_this2._emitSuccess();return}_this2._offset=offset;_this2._startUpload()}}},{key:"_startUpload",value:function _startUpload(){var _this3=this;if(this._aborted){return}var ws=this._newWebSocket();ws.onopen=function(event){console.log("[Start] WS opened: ",event);var headers=_this3._setRequestHeaders();headers["Upload-Offset"]=_this3._offset;headers["Content-Type"]="application/offset+octet-stream";var start=_this3._offset;var end=_this3._offset+_this3.options.chunkSize;if(end===Infinity||end>_this3._size){end=_this3._size}ws.send({method:"PATCH",headers:headers,body:_this3._source.slice(start,end)})};ws.onerror=function(event){console.log("[Start] WS error: ",event);if(_this3._aborted){return}_this3._emitError(new Error("tus: failed to upload chunk at offset "+_this3._offset))};ws.onclose=function(event){console.log("[Start] WS close: ",event);if(_this3._aborted){return}_this3._emitError(new Error("tus: failed to upload chunk at offset "+_this3._offset))};ws.onmessage=function(message){var response=JSON.parse(message.data);var headers=response.headers;console.log("[Start] WS message: ",message);console.log("[Start] WS data: ",response);if(!inStatusCategory(response.status,200)){_this3._emitError(new Error("tus: unexpected response while uploading chunk"));return}var offset=parseInt(headers["Upload-Offset"],10);if(isNaN(offset)){_this3._emitError(new Error("tus: invalid or missing offset value"));return}_this3._emitProgress(offset,_this3._size);_this3._emitChunkComplete(offset-_this3._offset,offset,_this3._size);_this3._offset=offset;if(offset==_this3._size){_this3._emitSuccess();_this3._source.close();return}_this3._startUpload()}}}]);return Upload}();function encodeMetadata(metadata){if(!Base64.isSupported){return""}var encoded=[];for(var key in metadata){encoded.push(key+" "+Base64.encode(metadata[key]))}return encoded.join(",")}function inStatusCategory(status,category){return status>=category&&status<category+100}Upload.defaultOptions=defaultOptions;exports.default=Upload},{"./base64":1,"./error":2,"./fingerprint":3,"./source":5,"./storage":6,extend:8}],8:[function(_dereq_,module,exports){"use strict";var hasOwn=Object.prototype.hasOwnProperty;var toStr=Object.prototype.toString;var isArray=function isArray(arr){if(typeof Array.isArray==="function"){return Array.isArray(arr)}return toStr.call(arr)==="[object Array]"};var isPlainObject=function isPlainObject(obj){if(!obj||toStr.call(obj)!=="[object Object]"){return false}var hasOwnConstructor=hasOwn.call(obj,"constructor");var hasIsPrototypeOf=obj.constructor&&obj.constructor.prototype&&hasOwn.call(obj.constructor.prototype,"isPrototypeOf");if(obj.constructor&&!hasOwnConstructor&&!hasIsPrototypeOf){return false}var key;for(key in obj){}return typeof key==="undefined"||hasOwn.call(obj,key)};module.exports=function extend(){var options,name,src,copy,copyIsArray,clone;var target=arguments[0];var i=1;var length=arguments.length;var deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(target==null||typeof target!=="object"&&typeof target!=="function"){target={}}for(;i<length;++i){options=arguments[i];if(options!=null){for(name in options){src=target[name];copy=options[name];if(target!==copy){if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=extend(deep,clone,copy)}else if(typeof copy!=="undefined"){target[name]=copy}}}}}return target}},{}]},{},[4])(4)});
//# sourceMappingURL=tus.min.js.map